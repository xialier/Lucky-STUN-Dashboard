<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Lucky STUN 状态</title>
	<style>
		body {
			/* 纯黑背景 */
			background-color: #000000;
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
			color: #ffffff;
			margin: 0;
			padding: 20px;
			display: flex;
			flex-direction: column;
			align-items: center;
			min-height: 100vh;
			/* 确保body本身可以自适应内容 */
			width: 100%;
			box-sizing: border-box;
		}

		.header {
			text-align: center;
			margin-bottom: 40px;
			padding: 20px;
			background: rgba(0, 0, 0, 0); /* 头部背景改为透明，以配合整体黑底 */
			border-radius: 12px;
			width: 90%; /* 保持响应式宽度 */
			max-width: 800px;
			box-sizing: border-box; /* 确保 padding 不会增加总宽度 */
		}

		.header h1 {
			font-size: 3.5em; /* 较大标题 */
			margin-bottom: 5px;
			color: #ffffff;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
		}

		/* 隐藏粉色横杠 */
		.header h1::after {
			content: none;
		}

		.header p {
			font-size: 1.4em; /* 较大日期时间 */
			color: #e0e0e0;
			margin-top: 5px;
		}

		.rules-container {
			display: grid;
			/* 核心响应式网格：自动适应列，每列最小200px，最大占满可用空间 */
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			width: 100%; /* 容器宽度为父元素100% */
			max-width: 1200px; /* 限制最大宽度 */
			padding: 20px;
			box-sizing: border-box; /* 确保 padding 不会增加总宽度 */
		}

		.rule-card {
			background-color: #E066A8; /* 接近图片中的粉紫色 */
			border-radius: 12px;
			padding: 20px;
			text-align: center;
			box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
			transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
			position: relative;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			height: 160px; /* 稍微固定高度，保持小卡片感 */
		}

		.rule-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
			background-color: #C74E8B; /* 悬停时稍微深一点的粉紫色 */
		}

		.rule-card h3 {
			font-size: 1.6em;
			margin-top: 0;
			margin-bottom: 10px;
			color: #ffffff;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
		}

		.rule-card p {
			font-size: 0.95em;
			margin: 5px 0;
			color: #ffffff;
		}

		.rule-card p strong {
			color: #ffffff;
			font-weight: normal;
		}

		a {
			text-decoration: none;
			color: inherit;
			display: block;
			height: 100%;
		}

		a:hover {
			color: inherit;
		}

		.footer {
			margin-top: auto;
			padding-top: 20px;
			font-size: 0.9em;
			color: #888888;
		}

		/* 媒体查询：针对中等屏幕（例如平板）进行调整 */
		@media (max-width: 992px) {
			.header h1 {
				font-size: 3em;
			}
			.header p {
				font-size: 1.2em;
			}
			/* .rules-container 保持 auto-fit, minmax(200px, 1fr) */
			.rule-card {
				height: 150px;
				padding: 18px;
			}
		}

		/* 媒体查询：针对小屏幕（例如手机）强制单列布局 */
		@media (max-width: 600px) { /* 更小的断点，更明确地针对手机 */
			body {
				padding: 10px;
			}
			.header {
				margin-bottom: 20px;
				padding: 15px;
			}
			.header h1 {
				font-size: 2em; /* 手机上进一步缩小标题 */
			}
			.header p {
				font-size: 1em; /* 手机上进一步缩小日期时间 */
			}
			.rules-container {
				/* 强制单列布局 */
				grid-template-columns: 1fr; 
				gap: 10px;
				padding: 10px;
			}
			.rule-card {
				height: auto; /* 手机上高度自适应，避免内容溢出 */
				min-height: 120px; /* 最小高度 */
				padding: 15px;
			}
			.rule-card h3 {
				font-size: 1.5em; 
			}
			.rule-card p {
				font-size: 0.9em; 
			}
			#login-container {
				padding: 25px;
			}
			#login-container h2 {
				font-size: 1.6em;
			}
			#password-input, #login-button {
				font-size: 1em;
				padding: 10px 12px;
			}
		}
	</style>
</head>
<body>
	<!-- 登录界面 -->
	<div id="login-container">
		<h2>请输入密码</h2>
		<input type="password" id="password-input" placeholder="密码">
		<button id="login-button">登录</button>
		<div id="login-error"></div>
	</div>

	<!-- 主 Dashboard 内容 -->
	<div id="dashboard-content" style="display: none;">
		<div class="header">
			<h1>Lucky STUN 状态</h1>
			<p id="current-datetime"></p>
		</div>

		<div class="rules-container" id="rules-container">
			<!-- 规则卡片将在这里通过 JavaScript 动态加载 -->
			<h3>加载中...</h3>
		</div>

		<div class="footer">
			<p>&copy; 2025 Lucky STUN Dashboard</p>
		</div>
	</div>

	<!-- 引入 Socket.IO 客户端库 -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
	<script>
		// --- 密码设置 ---
		const CORRECT_PASSWORD = "123321"; // <-- 请在这里设置您的密码，例如 "123456"
		const LOGIN_STATUS_KEY = "luckyStunLoggedIn"; // localStorage 存储键

		// --- 元素获取 ---
		const loginContainer = document.getElementById('login-container');
		const passwordInput = document.getElementById('password-input');
		const loginButton = document.getElementById('login-button');
		const loginError = document.getElementById('login-error');
		const dashboardContent = document.getElementById('dashboard-content');

		// --- Dashboard 核心元素 ---
		const rulesContainer = document.getElementById('rules-container');
		const currentDatetimeElement = document.getElementById('current-datetime');
		const fixedDomain = "xialier.dynv6.net"; // <-- 请在这里设置您的域名

		// --- 登录逻辑 ---
		function checkLoginStatus() {
			if (localStorage.getItem(LOGIN_STATUS_KEY) === "true") {
				showDashboard();
			} else {
				showLogin();
			}
		}

		function showLogin() {
			loginContainer.style.display = 'flex';
			dashboardContent.style.display = 'none';
		}

		function showDashboard() {
			loginContainer.style.display = 'none';
			dashboardContent.style.display = 'flex'; // 设置为 flex 才能正确布局
			initializeDashboard(); // 登录成功后初始化 Dashboard
		}

		function handleLogin() {
			const enteredPassword = passwordInput.value;
			if (enteredPassword === CORRECT_PASSWORD) {
				localStorage.setItem(LOGIN_STATUS_KEY, "true");
				loginError.textContent = "";
				showDashboard();
			} else {
				loginError.textContent = "密码错误，请重试。";
				passwordInput.value = ""; // 清空密码输入框
			}
		}

		// 绑定登录事件
		loginButton.addEventListener('click', handleLogin);
		passwordInput.addEventListener('keypress', function(event) {
			if (event.key === 'Enter') {
				handleLogin();
			}
		});

		// --- Dashboard 初始化和功能 ---
		let socket; // 将 socket 声明在外部，以便在需要时重新连接

		function initializeDashboard() {
			// 如果 Socket.IO 已经连接，则无需重新初始化
			if (!socket || !socket.connected) {
				socket = io(); // 重新初始化 Socket.IO 连接
				
				socket.on('connect', () => {
					console.log('与后端Socket.IO连接成功');
					fetchInitialData(); // 连接成功后获取一次数据
				});

				socket.on('disconnect', () => {
					console.log('与后端Socket.IO连接断开');
					rulesContainer.innerHTML = "<h3>与服务器连接断开，尝试重新连接...</h3>";
				});

				socket.on('all_rules_updated', (data) => {
					console.log('接收到所有规则更新数据:', data);
					renderRules(data); // 接收到更新后重新渲染
				});

				socket.on('connect_error', (error) => {
					console.error('Socket.IO 连接错误:', error);
					rulesContainer.innerHTML = "<h3>无法连接到服务器，请检查后端服务是否运行。</h3>";
				});
			} else {
				// 如果已经连接，直接获取并渲染数据
				fetchInitialData();
			}

			// 每秒更新一次当前时间显示
			setInterval(updateCurrentDatetime, 1000); // 每秒更新
			updateCurrentDatetime(); // 立即更新一次
		}

		// 格式化时间戳函数 (保留)
		function formatTimestamp(timestampValue) {
			if (!timestampValue) {
				return "N/A";
			}
			let date;
			if (typeof timestampValue === 'string' || typeof timestampValue === 'number') {
				const numValue = Number(timestampValue);
				if (!isNaN(numValue) && numValue > 0) {
					if (String(numValue).length === 13) {
						date = new Date(numValue);
					} else if (String(numValue).length === 10) {
						date = new Date(numValue * 1000);
					}
				}
			}
			if (!date || isNaN(date.getTime())) {
				if (typeof timestampValue === 'string') {
					const formattedTimestampStr = timestampValue.replace(/-/g, '/');
					date = new Date(formattedTimestampStr);
				}
			}
			if (!date || isNaN(date.getTime())) {
				return "无效时间";
			}
			const year = date.getFullYear();
			const month = (date.getMonth() + 1).toString().padStart(2, '0');
			const day = date.getDate().toString().padStart(2, '0');
			const hours = date.getHours().toString().padStart(2, '0');
			const minutes = date.getMinutes().toString().padStart(2, '0');
			const seconds = date.getSeconds().toString().padStart(2, '0');
			return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
		}

		// 渲染规则卡片函数
		function renderRules(rulesData) {
			rulesContainer.innerHTML = "";
			if (Object.keys(rulesData).length === 0) {
				rulesContainer.innerHTML = "<h3>暂无活动穿透规则，请稍后</h3>";
				return;
			}
			for (const ruleName in rulesData) {
				const rule = rulesData[ruleName];
				const ruleCard = document.createElement('div');
				ruleCard.classList.add('rule-card');
				const displayPort = rule.port || 'N/A';
				const linkHref = `http://${fixedDomain}:${displayPort}`;
				ruleCard.innerHTML = `
					<a href="${linkHref}" target="_blank">
						<h3>${ruleName}</h3>
						<p>公网端口: <strong>${displayPort}</strong></p>
						<p>更新: ${formatTimestamp(rule.timestamp)}</p>
					</a>
				`;
				rulesContainer.appendChild(ruleCard);
			}
		}

		// 获取并渲染初始数据 (保留)
		function fetchInitialData() {
			fetch('/get_lucky_ip')
				.then(response => response.json())
				.then(data => {
					renderRules(data);
				})
				.catch(error => {
					console.error('获取初始数据失败:', error);
					rulesContainer.innerHTML = "<h3>无法连接到服务器，请检查后端服务是否运行。</h3>";
				});
		}

		// 每秒更新一次当前时间显示 (保留)
		function updateCurrentDatetime() {
			const now = new Date();
			const year = now.getFullYear();
			const month = (now.getMonth() + 1).toString().padStart(2, '0');
			const day = now.getDate().toString().padStart(2, '0');
			const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][now.getDay()];
			const hours = now.getHours().toString().padStart(2, '0');
			const minutes = now.getMinutes().toString().padStart(2, '0');
			const seconds = now.getSeconds().toString().padStart(2, '0');
			currentDatetimeElement.textContent = `${year}年${month}月${day}日 星期${dayOfWeek} ${hours}:${minutes}:${seconds}`;
		}

		// 页面加载时检查登录状态
		document.addEventListener('DOMContentLoaded', checkLoginStatus);
	</script>
</body>
</html>
